library("ParamHelpers")
library("ggplot2")
library("data.table")
library("GNArchitect")
library("magrittr")

optruns <- readRDS("data/optruns.rds")  # generated by collect_run_results.R

optruns$metainfo$walltime <- round(optruns$metainfo$walltime)  # these are not true integers because of log -> exp precision loss

# all the wall time steps that were evaluated
walltimes <- unique(optruns$metainfo$walltime)

# the batchsize is also a property of the model we want to record.
optruns$optpath.x.transformed$batchsize <- optruns$metainfo$batchsize
optruns$metainfo$batchsize <- NULL

# How many different levels are there, effectively, for each hyperparameter?
# We can not use `optpath.x` here, since some values are continuous for the optimizer
# but transformation then rounds the value.
numlevels <- vapply(optruns$optpath.x.transformed, function(x) {
  x <- x[!is.na(x)]
  length(unique(x))
}, numeric(1))


params.nonparams <- c("runid", "num_targets")  # meta-info hyperparameters that are not interesting for analysis
params.params <- setdiff(names(numlevels), params.nonparams)  # names of all actual hyperparameters
params.continuous <- names(numlevels)[numlevels > 20] %>% setdiff(params.nonparams)
params.discrete <- setdiff(names(numlevels), c(params.nonparams, params.continuous))

# items for which we are interested in the respective maxima: i.e. best y for all walltimes, both maxlens, both model types.
splitby <- c("maxlen", "walltime", "model_type")

# get a median / mode value for x.
# For numeric values, get the median (round if integer), otherwise the mode.
consensus <- function(x) {
  if (is.integer(x)) return(round(median(x)))
  if (is.numeric(x)) return(median(x))
  if (is.logical(x)) return(as.logical((median(x))))  # this is the mode, since length(x) is odd
  if (all(is.na(x))) return(x[[1]])
  return(names(sort(-table(x)))[[1]])
}

getTopNTable <- function(topn) {
  alldata <- cbind(optruns$optpath.x.transformed, optruns$metainfo)
  alldata[by = splitby, .SDcols = setdiff(params.params, splitby), , {
    c(
      lapply(.SD[order(y, decreasing = TRUE)[seq_len(topn)]], consensus),
      list(desc = sprintf("median-of-%s_%shr_%s_len_%s", topn, walltime / 3600, model_type, maxlen))
    )
  }][, c(params.params, "desc"), with = FALSE]
}

# hyperparameters, together with performance y value, for each configuration
toptable <- cbind(optruns$optpath.x.transformed, optruns$metainfo)[, .SD[which.max(y)], by = splitby][, c(params.params, "y", "paramcount"), with = FALSE]
fwrite(toptable, "data/best_configs.csv")
fwrite(getTopNTable(3), "data/median_of_top_3.csv")
fwrite(getTopNTable(9), "data/median_of_top_9.csv")


optruns$metainfo
